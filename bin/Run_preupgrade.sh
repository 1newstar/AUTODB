#!/bin/bash
##########################################################################
# Title: Run_preupgrade.sh
# Purpose: Executes Oracle preupgrd.sql
# Created:
##########################################################################

. $WKDIR/bin/11g_Env.sh

export LOGDIR=$WKDIR/logs/${ORACLE_SID}
PREUPGLOG=${LOGDIR}/pre/Run_preupgrade_sql.log
ORCLUPGLOG=${ORACLE_HOME}/cfgtoollogs/${ORACLE_SID}/preupgrade/preupgrade.log
MAILID=`grep MAILID $PARFILE  | awk -F"=" '{print $2}'`

export ORACLE_HOME=`grep OLD_ORA_HOME $PARFILE  | awk -F"=" '{print $2}'`
#MB add loop this is for the user to fix any errors after running the preupgrade sql
#HZ added error handling

sqlplus -s "/ as sysdba"  <<EOF >${PREUPGLOG}
WHENEVER SQLERROR EXIT SQL.SQLCODE
set echo on
show parameter db_name
set lines 500 pages 500
@${ORACLE_HOME}/rdbms/admin/preupgrd.sql
--select ERR from dwdw.eeeee ;
exit sql.sqlcode
EOF
if [ $? -ne 0 ]; then
	echo "`date` Run_preupgrade.sh failed. Error: `grep ORA- ${PREUPGLOG} | head -1`"
	rm ${OPTION1} > /dev/null
	exit 1
#Send email notifcation
else
	echo "`date` No errors found."
	cat ${PREUPGLOG}
	SUBJECT="AutoDB : Pre-Upgrade STATUS: Complete - ${ORACLE_SID}@${HOSTNAME}"
	 if [ `whereis uuencode | cut -d' ' -f2 | grep -c "uuencode$"` -eq 0 ]; then
		echo "Pre Upgrade Status Complete. Verify all preupgrade errors and warning have been handled prior to continuing. View ${ORCLUPGLOG}  to view errors, warnings, and informational messages regarding database - ${ORACLE_SID}@${HOSTNAME}  - AutoGenerated by AUTODB" | mailx -s "$SUBJECT" $MAILID
		echo "`date` notification email sent without attachment. uuencode is not installed"
	else 
		echo "Pre Upgrade Status Complete. Verify all preupgrade errors and warning have been handled prior to continuing. View attached Preupgrade.log to view errors, warnings, and informational messages regarding database - ${ORACLE_SID}@${HOSTNAME}  - AutoGenerated by AUTODB" | mailx -s "$SUBJECT" -a ${ORCLUPGLOG} $MAILID
		echo "`date` email notification sent with attachment"
	fi

fi

echo "---------------------------------------------------------------------------------------------"
echo "---------------------------------------------------------------------------------------------"
echo "--------------------------------- preupgrd.sql complete -------------------------------------"
echo " "
echo "Please verify if all Pre Upgrade requirements were satisfied."
echo "You may open another terminal and correct all errors/warnings before continuing."
echo "Please press any key to continue."
read INPUTEND
