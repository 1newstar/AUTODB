#!/bin/bash
#################################################################################
# Title : update_oratab
# Description : Script updates the oratab entry to represent the new upgraded ORACLE_HOME,
# Details : The script adds a new line in the oratab with upgraded 12c environment and comments out the older 11g line
# Yo may wish to remove the commented line after completion of script
#
#Created: Michael Bathan 
#################################################################################
. $WKDIR/bin/12c_Env.sh

MAILID=`grep MAILID $PARFILE  | awk -F"=" '{print $2}'`
UPGSUMMARY=$ORACLE_HOME/cfgtoollogs/$ORACLE_SID/upgrade/upg_summary.log

if [ `uname -a | grep -c Linux` -ne 0 ]; then
        ORATAB=/etc/oratab
else
        ORATAB=/var/opt/oracle/oratab
fi

#These variables afre for test, remote these line
#--------------------------------------------------
#ORACLE_SID=WAa01
#ORATAB=/tmp/OUTT/oratab_test
#ORACLE_HOME=/u01/app/oracle/product/12.1.0.2/dbhome
#--------------------------------------------------
if [ `cat ${ORATAB} | grep -v "#" | grep "${ORACLE_SID}:" | wc -l` -eq 1 ]; then
	OLDENTRY=`cat ${ORATAB} | grep -v "#" | grep "${ORACLE_SID}:" | head -1`
	ORATABBAK=$WKDIR/oratab.bak
	sed /"${ORACLE_SID}"/d ${ORATAB} > ${ORATABBAK}
	cat ${ORATABBAK} > ${ORATAB}
	rm -f $ORATABBAK
	echo "#${OLDENTRY}" >> ${ORATAB}
	echo "${ORACLE_SID}:${ORACLE_HOME}:N" >> ${ORATAB}
	echo "`date` ${ORATAB} updated."
else
	echo "`date` update_oratab.sh failed. ORACLE_SID [${ORACLE_SID}] not found. Please update ORATAB to NEW ORACLE_HOME manually. "; rm ${OPTION2} > /dev/null; exit 1;
fi
SUBJECT="AUTODB : Upgrade STATUS: COMPLETE - ${ORACLE_SID}@${HOSTNAME}"
if [ `whereis uuencode | cut -d' ' -f2 | grep -c "uuencode$"` -eq 0 ]; then
	echo "Upgrade Status Complete. Please view Upgrade Summary ${UPGSUMMARY}. You may now begin the 'Post Upgrade' stage of AUTODB - ${ORACLE_SID}@${HOSTNAME}  - AutoGenerated by AUTODB" | mailx -s "$SUBJECT" $MAILID
                echo "`date` email notification sent without attachment. uuencode not installed"
else
	echo "Upgrade Status Complete. Please view Summary report attached. You may now begin the 'Post Upgrade' stage of AUTODB - ${ORACLE_SID}@${HOSTNAME}  - AutoGenerated by AUTODB" | mailx -s "$SUBJECT" -a ${UPGSUMMARY} $MAILID
fi

